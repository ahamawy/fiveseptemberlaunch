# Equitie Investor Portal

## Quick Start

```bash
npm install
npm run dev   # http://localhost:3001
```

**Default port is 3001** to avoid conflicts with Docker and other services. The app automatically configures itself for this port.

## Key Features

### Investor Portal

- `/investor-portal/dashboard` - Portfolio metrics and performance
- `/investor-portal/portfolio` - Holdings with real-time valuations
- `/investor-portal/transactions` - Transaction history
- `/investor-portal/deals` - Investment opportunities
- `/investor-portal/documents` - Document management
- `/investor-portal/profile` - Investor profile settings

### Admin Tools

- `/admin/chat` - AI assistant with fee calculations
- `/admin/fees` - Fees hub (admin)
- `/admin/deals` - Deals admin
- `/admin/transactions` - Transactions admin

## Environment Setup

```env
# .env.local
NEXT_PUBLIC_SUPABASE_URL=your-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-key
# New API key format (2025+) - both formats supported
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=sb_publishable_xxx
NEXT_PUBLIC_USE_MOCK_DATA=false
OPENROUTER_API_KEY=your-key
# Database connection (for migrations/scripts)
DATABASE_URL=postgresql://postgres.project:password@region.pooler.supabase.com:6543/postgres
# Optional branding
NEXT_PUBLIC_LOGO_URL=https://your-cdn-or-supabase-storage/logo.png
```

**Important Notes:**
- Node.js 20+ recommended (warnings shown for v18 and below)
- Supabase supports both old JWT format and new publishable key format (sb_publishable_*)
- The system automatically detects and uses the appropriate key format

### Supabase Schema Access

- Use `@supabase/supabase-js` with explicit schemas for cross‑schema tables:
  - Deals: `client.schema('deals').from('deal')`
  - Companies: `client.schema('companies').from('company')`
  - Public tables (e.g., `deal_formula_templates`) use default schema

## Testing

```bash
npx playwright test      # All tests
npx playwright test --ui  # Interactive
```

### Health Check

```bash
node SCRIPTS/health-check.js
```
Checks core pages and APIs and reports summary (expects 200s). Update routes in `SCRIPTS/health-check.js` as needed.

## Fee Engine

- Precedence-based ordering (PREMIUM first)
- Basis: GROSS | NET | NET_AFTER_PREMIUM
- Discounts as negative amounts
- Full audit trail

## Formula System

- Database‑driven formula templates and per‑deal assignments
- API:
  - `GET/POST /api/deals/[id]/formula`
  - `POST /api/deals/[id]/calculate`, `GET /api/deals/[id]/calculate`
- Admin UI: `/admin/formulas`, `/admin/formula-manager`

## Documentation

- **Main**: [CLAUDE.md](./CLAUDE.md)
- **Bot Context**: [MASTER_CONTEXT.md](./MASTER_CONTEXT.md)
- **API**: [DOCS/API.md](./DOCS/API.md)
- **Feature Map (human)**: [DOCS/FEATURE_MAP.md](./DOCS/FEATURE_MAP.md)
- **Feature Map (JSON)**: [DOCS/feature-map.json](./DOCS/feature-map.json)
- **DB Layer**: [lib/db/README.md](./lib/db/README.md)

### Branding & Icons

- Set `NEXT_PUBLIC_LOGO_URL` to display your logo in the navbar and generate favicons/app icons.
- Icons are generated by Next.js routes: `app/icon.tsx` (favicon) and `app/apple-icon.tsx` (Apple touch).
- If `NEXT_PUBLIC_LOGO_URL` is not set, a brand monogram is used with a gradient background.
  - Investors endpoint `/api/investors/[id]` accepts numeric id or `public_id`

## Database Sync (Drizzle)

- Add `SUPABASE_DB_URL` to `.env.local` (direct Postgres URL for your Supabase project).
- Generate typed schema from the live DB (read-only sync):
  ```bash
  npm run db:drizzle:introspect
  ```
- Keep DDL in SQL under `DB/migrations/` (source of truth for schema changes).
- App runtime: use `@supabase/supabase-js` (RLS-aware). Use `createDrizzleDirectClient()` ONLY for server scripts/ops.

## MCP Tooling (Docker-only)

- Run MCP services via Docker for isolation and modularity; avoid host-bound processes.
- Example pattern:
  ```bash
  docker run --rm \
    --env-file ./.env.local \
    -v "$PWD":/workspace \
    -w /workspace \
    your-mcp-image:latest
  ```

## Chat Commands

```text
"Calculate fees for deal 1 with $1M"
"Import CSV" → Upload file
"Show fee schedule"
```

## Project Structure

```
/app              # Pages & API
/lib/services     # Service layer
/lib/db          # Database
/components      # UI components
/DOCS           # Documentation
```

## Status (2025-08-27)

✅ **ARCHON Removed** - Formula engine is single source of truth
✅ **Clean Architecture** - Modular services, clear separation
✅ **Health Checks** - 100% passing (14/14 endpoints)
✅ **Schema Migration** - Clean tables, 61% storage reduction
✅ **Formula Engine** - 10 templates, full audit trail
✅ **AI Assistant** - Active with formula calculations

Branch: `main`

## Recent Changes

- **2025-08-27**: ARCHON fee engine completely removed
- **2025-08-25**: Schema migration to clean tables
- **Formula Engine**: Now handles all Net Capital calculations
- **Architecture**: Reviewed and documented in ARCHITECTURE_REVIEW.md
